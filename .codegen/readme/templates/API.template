# API
- [`Listen`](#listen)
{{ range $func := .API }}
- [`{{ titleCase $func.Name }}`](#{{ clean $func.Name }}){{ end }}
- [`GetCardRecord`](#getcardrecord)
- [`GetCardRecordAtIndex`](#getcardrecordatindex)
- [`PutCardRecord`](#putcardrecord)
- [`GetEventRecord`](API.md#geteventrecord)
- [`GetStatusRecord`](API.md#getstatusrecord)
- [`GetTimeProfileRecord`](API.md#gettimeprofilerecord)
- [`SetTimeProfileRecord`](API.md#settimeprofilerecord)
- [`AddTaskRecord`](API.md#addtaskrecord)
- [`Listen`](#listen)

---
Invoking an API function requires an instance of the `Uhppoted` struct initialised with the information required
to access a controller:

```
        u := lib.NewUhppoted(bind, broadcast, listen, debug)

where:

bind        IPv4 address to which to bind the UDP socket
broadcast   IPv4 address:port for broadcast UDP packets
listen      IPv4 address:port for events from controller
debug       Displays the controller requests/responses if true.
```

e.g.:
```
import (
    "fmt"
    "net/netip"

    lib "github.com/uhppoted/uhppoted-lib-go/src/uhppoted"
)

...
func main() {
    bind := netip.MustParseAddr("0.0.0.0")
    broadcast := netip.MustParseAddrPort("255.255.255.255:60000")
    listen := netip.MustParseAddrPort("0.0.0.0:60001")
    debug := true

    u := lib.NewUhppoted(bind, broadcast, listen, options.debug)
    
    if controller, err := lib.GetController(u, 405419896); err != nil {
        fmt.Printf("ERROR %v\n", err)
    } else {
        fmt.Printf("%v\n", controller)
    }
}
```

### Notes
1. All API functions return an error if the call fails for any reason whatsoever.
2. All API functions (other than `get_all_controllers` and `listen`) take a `controller` that may be either:
   - a _uint32_ controller serial number (legacy)
   - a Controller struct
```
type Controller struct {
    ID       uint32
    Address  netip.AddrPort
    Protocol string
}

where:
- ID        controller serial number
- Address   controller IPv4 address and port. 
            (optional - defaults to UDP broadcast if not provided)
- Protocol  either "udp" or "tcp". 
            (optional - defaults to "udp")
```
   e.g.:
```
   lib.GetController(u, 405419896, TIMEOUT)
   lib.GetController(u, lib.Controller{
                           405419896, 
                           netip.MustParseAddrPort('192.168.1.100:60000'), 
                           'tcp'}, TIMEOUT)
```

3. All API functions (other than `listen`) take a `timeout` parameter that sets the time limit for the request, 
   e.g.:
```
   GetController(u, 405419896, 750*time.Millisecond)
```

4. `datetime` args (e.g. `SetTime`) take a `TDateTime` type which may be either a time-zone free `entities.DateTime` or a 
Go stdlib `time.Time`:
```
    ...
    return lib.SetTime(u, c, time.Now(), options.timeout)
```
```
    ...
    return lib.SetTime(u, c, entities.DateTime(2025, 3, 25, 12, 34, 56), options.timeout)
```

A `DateTimeFromTime` helper function is provided which converts a stdlib `time.Time` to an `entities.DateTime`.


5. `date` args (e.g. `PutCard`) take a `TDate` type which may be either a time-zone free `entities.Date` or a 
Go stdlib `time.Time`:

A `DateFromTime` helper function is provided which converts a stdlib `time.Time` to an `entities.DateTime`.


## Functions
{{ range $func := .API }}
### `{{ titleCase $func.Name }}`
{{ range $text := $func.Description}}{{ $text }}
{{end -}}
```
{{ titleCase $func.Name }}(u{{range $arg := $func.Args}}, {{ $arg.Name}}{{end}}, timeout)

where:
- u             Uhppoted        Uhppoted struct initialised with the bind address, broadcast address, etc
{{- range $arg := $func.Args}}
- {{ rpad $arg.Name 12 }}  {{ rpad $arg.Type 14 }}  {{ $arg.Description }}{{end}}
- timeout       time.Duration   maximum time to wait for a response from a controller
```
Returns {{ article $func.Response.Name }} `{{ titleCase $func.Response.Name }}`:
```
type {{ titleCase $func.Response.Name }} struct { {{ range $field := $func.Response.Fields}}
  {{ rpad (titleCase $field.Name) 18 }}  {{ rpad $field.Type 18 }}  {{ rpad (printf "`json:%q`" $field.Tag) 23 }} // {{ $field.Description }}{{ end }}
}
```
{{ end }}
### `GetCardRecord`
Retrieves the card record for a given card number.
```
GetCardRecord(u, controller, card, timeout)

where:
- u             Uhppoted        Uhppoted struct initialised with the bind address, broadcast address, etc
- controller    controller      uint32|Controller controller serial number or {id, address, protocol} Controller struct
- card          uint32          card number
- timeout       time.Duration   maximum time to wait for a response from a controller
```
Returns a `Card` record:
```
type Card struct { 
  Card          uint32            `json:"card"`           // card number
  StartDate     Date              `json:"start-date"`     // 'valid from' date
  EndDate       Date              `json:"end-date"`       // 'valid until' date
  Permissions   map[uint8]uint8   `json:"permissions"`    // access permissions for doors 1-4
  PIN           uint32            `json:"PIN"`            // PIN code [0..999999] (0 for no PIN)
}
```

### `GetCardRecordAtIndex`
Retrieves the card record stored at a given index.
```
GetCardRecordAtIndex(u, controller, index, timeout)

where:
- u             Uhppoted        Uhppoted struct initialised with the bind address, broadcast address, etc
- controller    controller      uint32|Controller controller serial number or {id, address, protocol} Controller struct
- index         uint32          card record index
- timeout       time.Duration   maximum time to wait for a response from a controller
```
Returns a `Card` record:
```
type Card struct { 
  Card          uint32            `json:"card"`           // card number
  StartDate     Date              `json:"start-date"`     // 'valid from' date
  EndDate       Date              `json:"end-date"`       // 'valid until' date
  Permissions   map[uint8]uint8   `json:"permissions"`    // access permissions for doors 1-4
  PIN           uint32            `json:"PIN"`            // PIN code [0..999999] (0 for no PIN)
}
```


### `PutCardRecord`
Creates or updates a card record stored on an access controller.
```
PutCardRecord(u, controller, card, timeout)

where:
- u             Uhppoted        Uhppoted struct initialised with the bind address, broadcast address, etc
- controller    controller      uint32|Controller controller serial number or {id, address, protocol} Controller struct
- card          Card            card record to add/update
- timeout       time.Duration   maximum time to wait for a response from a controller

where a Card record is:

type Card struct { 
  Card          uint32            // card number
  StartDate     Date              // 'valid from' date
  EndDate       Date              // 'valid until' date
  Permissions   map[uint8]uint8   // access permissions for doors 1-4
  PIN           uint32            // PIN code [0..999999] (0 for no PIN)
}
```
Returns a `bool`, `true` if the card was added or updated, `false` otherwise.


### `GetStatusRecord`
Retrieves the status record for a controller.
```
GetStatusRecord(u, controller, timeout)

where:
- u             Uhppoted        Uhppoted struct initialised with the bind address, broadcast address, etc
- controller    controller      uint32|Controller controller serial number or {id, address, protocol} Controller struct
- timeout       time.Duration   maximum time to wait for a response from a controller
```
Returns a `Status` record:
```
type Status struct {
  System struct {
    Time  DateTime `json:"datetime"`       // controller system date and time, e.g. 2025-07-21 13:25:47
    Error uint8    `json:"error"`          // system error code
    Info  uint8    `json:"info"`           // absolutely no idea
  } `json:"system"`

  Doors map[uint8]struct {
    Open     bool `json:"open"`            // door open sensor
    Button   bool `json:"button"`          // door button pressed
    Unlocked bool `json:"unlocked"`        // door unlocked
  } `json:"doors"`

  Alarms struct {
    Flags      uint8 `json:"flags"`        // bitset of alarm inputs
    Fire       bool  `json:"fire"`         // fire alarm (bit 0)
    LockForced bool  `json:"lock-forced"`  // lock forced (bit 1)
  } `json:"alarms"`

  Event Event `json:"event"`               // most recent event
}
```


### `GetEventRecord`
Retrieves the event record for the event at a given index.
```
GetEventRecord(u, controller, index, timeout)

where:
- u             Uhppoted        Uhppoted struct initialised with the bind address, broadcast address, etc
- controller    controller      uint32|Controller controller serial number or {id, address, protocol} Controller struct
- index          uint32         event index
- timeout       time.Duration   maximum time to wait for a response from a controller
```
Returns an `Event` record:
```
type Event struct { 
  Index          uint32             `json:"index"`       // event index
  EventType      uint8              `json:"event-type"`  // event type 
  AccessGranted  bool               `json:"granted"`     // true if the door was unlocked
  Door           uint8              `json:"door"`        // door no. ([1..4]) for card and door events
  Direction      uint8              `json:"direction"`   // direction (1:IN, 2:OUT) for card and door events
  Card           uint32             `json:"card"`        // card number (for card events)
  Timestamp      optional datetime  `json:"timestamp"`   // event timestamp
  Reason         uint8              `json:"reason"`      // reason code
}
```

### `SetTimeProfileRecord`

Adds or updates an access time profile stored on a controller.
```
SetTimeProfile(u, controller, profile, timeout)

where:
- u             Uhppoted        Uhppoted struct initialised with the bind address, broadcast address, etc
- controller    controller      uint32|Controller controller serial number or {id, address, protocol} Controller struct
- profile       TimeProfile     TimeProfile struct intialised with the desired time profile.
- timeout       time.Duration   maximum time to wait for a response from a controller
```

Returns `true` or `false`.

```
type TimeProfile struct {
  Profile       uint8         `json:"profile"`         // profile Id ([2..254] to create/update
  StartDate     Date          `json:"start-date"`      // date from which profile is valid (inclusive)
  EndDate       Date          `json:"end-date"`        // date after which profile is invalid
  Weekdays      Weekdays      `json:"weekdays"`        // days of week on which profile is enabled
  Segments      []TimeSegment `json:"segments"`        // time segments during day during which profile is enabled
  LinkedProfile uint8         `json:"linked-profile"`  // linked time profile
}

type Weekdays struct {
  Monday    bool `json:"monday"`     // profile valid on Monday if true
  Tuesday   bool `json:"tuesday"`    // profile valid on Tuesday if true
  Wednesday bool `json:"wednesday"`  // profile valid on Wednesday if true
  Thursday  bool `json:"thursday"`   // profile valid on Thursday if true
  Friday    bool `json:"friday"`     // profile valid on Friday if true
  Saturday  bool `json:"saturday"`   // profile valid on Saturday if true
  Sunday    bool `json:"sunday"`     // profile valid on Sunday if true
}

type TimeSegment struct {
  Start HHmm `json:"start"`  // segment start time
  End   HHmm `json:"end"`    // segment end time
}
```


### `Listen`
Listens for controller events sent via UDP to the designated listener host.
```
Listen(u, events chan ListenerEvent, errors chan error, interrupt chan os.Signal) error {

where:
- u          Uhppoted            Uhppoted struct initialised with the bind address, broadcast address, etc
- listener   Listener            implementation of the IListener interface
- interrupt  chan os.Signal      interrupts channel

type IListener interface {
  OnEvent(ListenerEvent)
  OnError(error)
}
```

- received events invoke the listener `OnEvent` function
- non-fatal errors invoke the listener `OnError` function
- signals posted on the interrupts channel cause the event listener to close and return

The example _CLI_ and the integration tests demonstrate implementations of IListener using channels and callbacks respectively.

```
type ListenerEvent struct { 
  Controller          uint32        `json:"controller"`      // controller serial number
  SystemDate          Date          `json:"system-date"`     // controller system date, e.g. 2025-07-21
  SystemTime          Time          `json:"system-time"`     // controller system time, e.g. 13:25:47
  Door1Open           bool          `json:"door-1-open"`     // door 1 open sensor
  Door2Open           bool          `json:"door-2-open"`     // door 2 open sensor
  Door3Open           bool          `json:"door-3-open"`     // door 3 open sensor
  Door4Open           bool          `json:"door-4-open"`     // door 4 open sensor
  Door1Button         bool          `json:"door-1-button"`   // door 1 button pressed
  Door2Button         bool          `json:"door-2-button"`   // door 2 button pressed
  Door3Button         bool          `json:"door-3-button"`   // door 3 button pressed
  Door4Button         bool          `json:"door-4-button"`   // door 4 button pressed
  Relays              uint8         `json:"relays"`          // bitset of door unlock relay states
  Inputs              uint8         `json:"alarm-inputs"`    // bitset of alarm inputs
  SystemError         uint8         `json:"system-error"`    // system error code
  SpecialInfo         uint8         `json:"special-info"`    // absolutely no idea
  EventIndex          uint32        `json:"event-index"`     // last event index
  EventType           uint8         `json:"event-type"`      // last event type
  EventAccessGranted  bool          `json:"event-granted"`   // last event access granted
  EventDoor           uint8         `json:"event-door"`      // last event door
  EventDirection      uint8         `json:"event-direction"` // last event door direction (0: in, 1: out)
  EventCard           uint32        `json:"event-card"`      // last event card number
  EventTimestamp      DateTime      `json:"event-timestamp"` // last event timestamp
  EventReason         uint8         `json:"event-reason"`    // last event reason
  SequenceNo          uint32        `json:"sequence-no"`     // packet sequence number
}
```

